<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; background-color: black !important;}
      h1, h2, h3 { font-family: 'Yanone Kaffeesatz'; font-weight: normal; }
      .back-h1 h1 { background-color: black; padding: 20px}
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .black { background-color: black }
      .almostblack { background-color: #091513 }
      .invert { color: white; }
      .strike { text-decoration: line-through;}
      .switcher h3 { color: #d3d3d3 }
      .switcher h3 strong { color: black }
      .bad { background-color: #AA1914; color: white;}
      .oki { background-color: #3D9972; color: white;}

      canvas.red { border: 3px solid red }
      canvas.whitebg {background-color: white}
      canvas.bottom { position:absolute; bottom: 0px }
      canvas.absolute { position:absolute; }

      .larger code { font-size: 30px }
      .medium code { font-size: 25px }

      .l20 { width: 20%; float: left }
      .l30 { width: 30%; float: left }
      .l40 { width: 40%; float: left }
      .l50 { width: 50%; float: left }
      .l60 { width: 60%; float: left }
      .l70 { width: 70%; float: left }
      .r30 { float: right; width: 30%; }
      .r40 { float: right; width: 40%; }
      .r50 { float: right; width: 50%; }
      .r70 { float: right; width: 70%; }
      .r60 { float: right; width: 60%; }
      .r80 { float: right; width: 80%; }

      .testcontainers { background-color: #0e1f26}
      .growbot { background-color: #6A4CA6}

      .splash {
        color: white;
        background-color: black;
      }

      .splash h1 {
        font-size: 70px;
      }

    </style>
  </head>
  <body>
    <textarea id="source">


class: center, middle, splash
# Pragmatic Continuous Delivery
## Day I

---
class: center, middle, splash
# Continuous Delivery 101

---
background-image: url(scrum_vs_cd.png)

---
background-image: url(devops_engineer.png)

---
.l30.switcher[
### **DevOps**
### Kanban
### Continuous Integration
### Continuous Testing
### Continuous Delivery
### Continuous Deployment
]

---
.l30.switcher[
### DevOps
### **Kanban**
### Continuous Integration
### Continuous Testing
### Continuous Delivery
### Continuous Deployment
]
???
- Kanban is a system for visualizing work (optimizing value stream via specific techniques)

---
.l30.switcher[
### DevOps
### Kanban
### **Continuous Integration**
### Continuous Testing
### Continuous Delivery
### Continuous Deployment
]

---
.l30.switcher[
### DevOps
### Kanban
### Continuous Integration
### **Continuous Testing**
### Continuous Delivery
### Continuous Deployment
]

---
.l30.switcher[
### DevOps
### Kanban
### Continuous Integration
### Continuous Testing
### **Continuous Delivery**
### Continuous Deployment
]
.r70[
## What?
### A methodology for reducing the **cost**, **time** and **risk** of delivering incremental changes to users.
## Qualities
### 1. Software is always in shippable state once code is pushed into the mainline (including infrastructure, configuration, data)
### 2. Push-button deployment for any desired version
]
???
**What**
- cost (optimize, automate)
- time (eliminate bottlenecks and waste, reducing wip)
- risk (small increments, reliability (no manual steps, consisteny), rollbacks, resiliance, mmtd, mmtr)
-
1. No need to wait for off-peak hours; non-ready features are deployed too;
2. Including old versions, rollbacks

---
.l30.switcher[
### DevOps
### Kanban
### Continuous Integration
### Continuous Testing
### Continuous Delivery
### **Continuous Deployment**
]
???
So Scrum vs. CD?

---
class: center, middle
# Why Continuous Delivery?
???
- a matter of survival for startups! (limited $, exploring ideas)
- competition! (startups beating enterprises because money is accessible. Citadele vs 4finance)
- competition! (customers are eager for cool things, e.g. Askfm)
- custom development is uber expensive

---
class: center, middle
> ## High-performing organizations are deploying code 30 times more frequently, with 50 percent fewer failures than their lower-performing counterparts.
### [State of DevOps Report](https://puppetlabs.com/sites/default/files/2014-state-of-devops-report.pdf) (2014)

---
class: center, middle
# Amazon
## new code is deployed every 11.6 seconds during a normal business day (3K production deployments per day)

---
class: center, middle
# Facebook
## each of 5,000 engineers commits to trunk HEAD at least once a day and the code at trunk HEAD is pushed to production once daily

---
class: center, middle
# Etsy
## 50 deploys/day

---
class: center, middle
# Google
## 15K engineers work from the HEAD revision of a single Perforce trunk. 50% of the code will be changed in any given month. 8 minutes after you commit code it's live in production.


---
class:center, middle
> ## .switcher[This book integrates into a compelling narrative the best current thinking about how to create great software-intensive products and services. The approach in this book is both challenging and disciplined, and **some organizations will be unable to imagine following this path. But those who make the journey will find it impossible to imagine ever going back—and if they happen to be a competitor, they are well positioned to steal both your market and your people**. Ignore this book at your own risk.]
### **(c) Mary Poppendieck**

---
class: center, middle, splash
# Anatomy of Deployment Pipeline

---
background-image: url(pipeline_classic.png)
???
Fail-fast

---
background-image: url(pipeline_classic.png)
## All changes to production go through deployment pipeline
???
Easy to ensure - you just restrict deployment from local machines.
### Every change triggers the feedback process

---
background-image: url(pipeline_classic.png)
## All changes to production go through version control (from mainline!)
???
- No release branches! No "quick fixes"!
- RB evil - Bug fixing: you fix it twice. In different codebases. Do you write tests twice too?
- No releases from feature branches.

---
background-image: url(pipeline_classic.png)
## Build only once
???
Every build is potential release (vs. SNAPSHOT, BETA etc.)

---
background-image: url(pipeline_classic.png)
## Test on production-like environment
???
Or test on production!

---
background-image: url(pipeline_classic.png)
## Deploy the same way to every environment

---
class: center, middle, splash
# Commit Stage

---
# Continuous Integration compliance checklist
### 1. All developers push the code at least once a day (to Mainline)
### 2. All developers run tests locally before pushing the code (and never push the code if tests fail)
### 3. **Every change** results in a build and tests run
### 4. Developers never push the code if a build is broken (why the build is broken if #3 is true?)
### 5. Build is **always** fixed within ten minutes of it going red
???
2. not daily, every H. but every build!

---
class: center, middle, bad
# I will work in a branch and sync with Mainline every day.
## (and push when my feature is ready)
???
But what if no one pushes like you do?

---
class: center, middle, bad
# I will use Mainline as a primary tool for identifying regression in my code

---
# CI changes dynamics of a game
### - No painful merges (try aggressive refactoring w/o CI)
### - Small increments (easier code review, more opportunities for pairing)
### - Evergreen Mainline requires engineering rigor (TDD, preflight quality control)
### - Feature branching becomes unnecessary (brings back synchronous code reviews)
### - Faster feedback from Sheriff on Duty (SoD)
### - Faster feedback from downstream quality gates (if any)
???
- Not only SoD, but all workstreams can see and use your code - awesome!
- One goal, extra care. If someone can release "in a special way", he doesn't care.

---
class: center, middle
## One thing that I really like about open-source is that it really allows different people to work together. We don't have to like each other. And sometimes we really don't like each other.
## (c) Linus Torvalds
### http://www.ted.com/talks/linus_torvalds_the_mind_behind_linux

---
background-image:url(jenkins_pipeline.png)
???
- Every version is release candidate
- The most annoying and complex task is button push
- We propagate the version to downstream jobs

---
background-image:url(jenkins_pipeline.png)
<canvas width="300" height="400" class="red" />
???
CI forces us to push!

---
class: center, middle, challenge
# Dealing with unfinished functionality

---
class: black, invert
background-image:url(toggles.png)
# Feature Toggles

---
class: black, invert
background-image:url(toggles.png)
# Feature Toggles
### - Release Toggles
### - Business Toggles
???
- RT - usually  removed after release
- BT - stays in code

---
class: black, invert
background-image:url(toggles.png)
# Use cases
### - Decoupling deployment from release
### - Enabling feature for subgroup of users
### - A/B testing
### - Addition to circuit breaking
???
- QA, by region, 1%
- Custom flipping strategies (e.g. release on specific date)
- E.g. too much users, feature is disabled.

---
background-image:url(ff4j.png)
???
Tracking feature usage
Custom toggle flipping strategies (specific date)

---
background-image:url(ff4j_console.png)

---
class: larger, middle
```java
if (ff4j.exist("new-feature")) {
    // new-feature exists
}

if (ff4j.check("new-feature")) {
    // new-feature is toggled
}
```

---
background-image:url(launchdarkly.png)

---
class: bad, invert, center, middle
# Anti-pattern: Feature Toggles introduce additional failure mode

---
class: center, middle
> ### Release toggles are a useful technique and lots of teams use them. However they should be your last choice when you're dealing with putting features into production. Your first choice should be to break the feature down so you can safely introduce parts of the feature into the product. The advantages of doing this are the same ones as any strategy based on small, frequent releases. You reduce the risk of things going wrong and you get valuable feedback on how users actually use the feature that will improve the enhancements you make later.
### (c) Martin Fowler at [Bliki](http://martinfowler.com/bliki/FeatureToggle.html)

---
class: center, middle, challenge
# Breaking changes

---
class: center, middle
# Rule: In Continuous Delivery there are no breaking changes
???
And no feature branches :-)

---
class: center, middle
# Branch by Abstraction vs. .strike[Branch by Source Control]
???
Instead of changing component...

---
background-image:url(bba.png)

---
background-image:url(bba2.png)

---
background-image:url(bba3.png)

---
background-image:url(bba4.png)

---
background-image:url(bba5.png)
???
Large-scale refactoring done right


---
class: center, middle
background-image:url(strangler.png)

---
class: center, middle
# ?
???
What about changing an API?

---
background-image:url(api_calendar.jpg)
???
Calendar of API changes

---
background-image:url(semver.png)

---
class: center, middle
# Meaningful commits

---
# 4W
## **W**ho
## **W**hen
## **W**hat
## **W**hy
## .strike[How]

---
class: larger
.l20[
# 4W
## **W**ho
## **W**hen
## **W**hat
## **W**hy
## .strike[How]
]
.r80[
```sh
$ git log --oneline -5 --author cbeams --before "Fri Mar 26 2009"

e5f4b49 Re-adding ConfigurationPostProcessorTests after its brief removal in r814. @Ignore-ing the testCglibClassesAreLoadedJustInTimeForEnhancement() method as it turns out this was one of the culprits in the recent build breakage. The classloader hacking causes subtle downstream effects, breaking unrelated tests. The test method is still useful, but should only be run on a manual basis to ensure CGLIB is not prematurely classloaded, and should not be run as part of the automated build.
2db0f12 fixed two build-breaking issues: + reverted ClassMetadataReadingVisitor to revision 794 + eliminated ConfigurationPostProcessorTests until further investigation determines why it causes downstream tests to fail (such as the seemingly unrelated ClassPathXmlApplicationContextTests)
147709f Tweaks to package-info.java files
22b25e0 Consolidated Util and MutableAnnotationUtils classes into existing AsmUtils
7f96f57 polishing
```

&nbsp;

```sh
$ git log --oneline -5 --author pwebb --before "Sat Aug 30 2014"

5ba3db6 Fix failing CompositePropertySourceTests
84564a0 Rework @PropertySource early parsing logic
e142fd1 Add tests for ImportSelector meta-data
887815f Update docbook dependency and generate epub
ac8326d Polish mockito usage
```
### -> [How to Write a Git Commit Message](http://chris.beams.io/posts/git-commit/)
]
???
How is clear from code.

---
background-image:url(jenkins_pipeline.png)
???

---
background-image:url(jenkins_pipeline.png)
<canvas width="380" height="400" class="red" />
???
We have to run unit tests twice - before pushing the code, and then on CI.

---
class: center, middle
# 6 Deadly Sins of A Unit Test
???
Setting common ground: A unit tests is a test that exercises class. So unit is a class.

---
# Unstable
### OS-specifics
### Wildcard dependency versions
### Shared state in tests
### System Time
### Asynchrony
### Concurrency
???
Wildcards - build becomes a lottery
Refactor shared state - test scoping, passing parameters via methods, constructor...

---
background-image:url(awaitility.png)

---
class: middle, larger
```java
public class FlawedList<T> extends ArrayList<T> {
  public boolean putIfAbsent(T object) {
    boolean absent = !super.contains(object);
    if (absent) {
      super.add(object);
    }
    return absent;
  }
}
```

---
class: middle, larger
```java
@Test
public void testPutIfAbsent() {
  FlawedList<String> list = new FlawedList<String>();
  list.putIfAbsent("foo");
  list.putIfAbsent("foo");
  assertThat(list.size(), is(1));
}
```

---
class: middle, larger
```java
FlawedList<String> list = new FlawedList<String>();

@Test(threadPoolSize = 5, invocationCount = 20)
public void testList() {
  list.putIfAbsent("foo");
  assertThat(list.size(), is(1));
}
```

---
background-image:url(thread_weaver.png)

---
class: middle, larger
```java
public class WeavedFlawedListTest {
  private FlawedList<String> list;

  @ThreadedBefore public void before() {
    list = new FlawedList<String>();
  }

  @ThreadedMain public void mainThread() {
    list.putIfAbsent("foo");
  }

  @ThreadedSecondary public void secondThread() {
    list.putIfAbsent("foo");
  }

  @ThreadedAfter public void after() {
    assertEquals(1, list.size());
  }
}
```

---
class: middle, larger
```java
public class FlawedList<T> extends ArrayList<T> {
  public boolean putIfAbsent(T object) {
    boolean absent = !super.contains(object);
    if (absent) {
      super.add(object);
    }
    return absent;
  }
}
```

---
.l50[
# Unreliable
### No tests - bad
### Bad tests - even worse
]
.r50[
![](goos.jpg)
]
???
passing tests usually do not indicate readiness to deploy. But failing tests do not indicate non-readiness :-)))
100% coverage doesn't mean anything

---
background-image:url(pitest.png)

---
.l50[
# Slow
### Implicit waiting
### Computation-intensive
# Stupid
### Code coverage boosters
### Fuzzing
]
.r50[
# Sequential
### Shared state
### &nbsp;
# Sociable
### Relying on concrete classes
]
???
CI - external module
Sociable - we write the tests assuming everything other than that unit is working correctly.

---
class: switcher
# Being sociable is OK, if:
### Dependency on non-trivial execution context (e.g. Spring)
### File system
### SMTP client
### SQL repository
### Redis repository
???
If your class talks to file system and you have never saw it writing a file - can you trust your tests?

---
class: switcher
# Being sociable is OK, if:
### **Dependency on non-trivial execution context (e.g. Spring)**
### File system
### SMTP client
### SQL repository
### Redis repository
???
- E.g. custom BeanPostProcessor - small, custom context. Extract to library.

---
class: switcher
.l60[
# Being sociable is OK, if:
### Dependency on non-trivial execution context (e.g. Spring)
### **File system**
### SMTP client
### SQL repository
### Redis repository
]
.r40[
![](jimfs.png)
]

---
class: switcher
# Being sociable is OK, if:
### Dependency on non-trivial execution context (e.g. Spring)
### File system
### **SMTP client**
### SQL repository
### Redis repository

---
class: switcher
.l60[
# Being sociable is OK, if:
### Dependency on non-trivial execution context (e.g. Spring)
### File system
### SMTP client
### **SQL repository**
### Redis repository
]
.r40[
![](h2.png)
]

---
class: switcher
.l60[
# Being sociable is OK, if:
### Dependency on non-trivial execution context (e.g. Spring)
### File system
### SMTP client
### SQL repository
### **Redis repository**
]
.r40[
![](holyshit.png)
]
???

---
background-image:url(docker.png)

---
background-image:url(docker-redis.png)
???
Problem: version missing!

---
class: testcontainers
background-image:url(testcontainers.png)


---
class: medium, middle
```java
class RedisBackedCacheTest {

    @Rule
    public GenericContainer redis = new GenericContainer("redis:3.0.6")
                                            .withExposedPorts(6379);
    private Cache cache;

    @Before
    public void setUp() {
        Jedis jedis = new Jedis(redis.getIpAddress(), redis.getMappedPort(6379));
        cache = new RedisBackedCache(jedis, "test");
    }

    @Test
    public void findsAnInsertedValueInCache() {
        String key = "foo";
        cache.put(key, "FOO");
        Optional<String> cacheHit = cache.get(key, String.class);
        assertThat(cacheHit, isPresent());
    }

}
```

---
class: medium, middle
```java
class RedisBackedCacheTest {

    @ClassRule
    public static GenericContainer redis = new GenericContainer("redis:3.0.6")
                                            .withExposedPorts(6379);
    private Cache cache;

    @Before
    public void setUp() {
        Jedis jedis = new Jedis(redis.getIpAddress(), redis.getMappedPort(6379));
        cache = new RedisBackedCache(jedis, "test");
    }

    @Test
    public void findsAnInsertedValueInCache() {
        String key = UUID.randomUUID().toString()
        cache.put(key, "FOO");
        Optional<String> cacheHit = cache.get(key, String.class);
        assertThat(cacheHit, isPresent());
    }

}
```
???
- Specific containers available
- Can wrap your Mongo or Cassandra

---
background-image:url(sysdig.png)

---
background-image:url(wiremock.png)


---
class: medium, middle
```java
class UberSmartHttpClientTest {

  @Rule
  public WireMockRule wireMockRule = new WireMockRule(8089);

  @Test
  public void exampleTest() {
      stubFor(get(urlEqualTo("/my/resource"))
              .withHeader("Accept", equalTo("text/xml"))
              .willReturn(aResponse()
                  .withStatus(200)
                  .withHeader("Content-Type", "text/xml")
                  .withBody("<response>Some content</response>")));

      Result result = uberSmartHttpClient.doSomeHttpRequest();

      assertTrue(result.wasSuccessful());
  }

}
```

---
class: medium, middle
```java
stubFor(get(urlEqualTo("/delayed")).willReturn(
        aResponse()
                .withStatus(200)
                .withFixedDelay(2000)));
```
???
- simulating faults - very hard to achieve when you do integration testing
- actually, we never do IT. For every service provider we create a test double.

---
background-image:url(mountebank.png)

---
background-image:url(jenkins_pipeline.png)

---
background-image:url(jenkins_pipeline.png)
<canvas width="650" height="200" class="red absolute" style="left: 450px; bottom: 150px" />
???
- Why RPM - uberjars are usually enough, but once you have to distribute more files with JAR (e.g. init scripts)- you need an archive.
- Ansible loves YUM!
- Btw, in case of RPM, you don't have to build JAR inside. Package compiled classes.

---
.l50[
# YUM repository
### - Nexus
### - Artifactory
### - [yum-s3-plugin](https://github.com/jbraeuer/yum-s3-plugin)
### - [yum-s3-iam](https://github.com/seporaitis/yum-s3-iam)
]
.r50[
# RPM packager
### - [fpm](https://github.com/jordansissel/fpm)
### - [gradle-ospackage-plugin](https://github.com/nebula-plugins/gradle-ospackage-plugin)
]


---
class: black
background-image:url(tree.png)

---
class: medium
### supervisor.conf
```supervisord
[program:app]
command=java -port=3000 -logdir=/var/log/app/ -jar /opt/app/current/app.jar
user=deployer
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/var/log/app/stdout.log
stderr_logfile=/var/log/app/stderr.log
```
???
Autorestart!!! Win time before admin on duty can help!!!

---
### deploy-playbook.yml
```ansible
- hosts: all
  serial: 1
  tasks:
   - name: install the app
     yum: name=app-{{version}} state=present
     notify:
      - restart supervisord
  handlers:
    - name: restart supervisord
      service: name=supervisord state=restarted

    - name: start the app
      supervisorctl: name=app state=started

    - name: health check
      health_check:
          url: "{{inventory_hostname}}/health"
          delay_between_tries: 5
          max_retries: 20
          expected_regexp: "alive"
  pre_tasks:
    - name: disable nagios alerts for this host webserver service
      nagios: action=disable_alerts host={{ inventory_hostname }} services=webserver

    - name: disable the server in haproxy
      haproxy: state=disabled host={{ inventory_hostname }}

    - name: stop the app
      supervisorctl: name=app state=stopped
```
???
-- graceful shutdown!!! http request must be completed (Jetty, StatisticsHandler polling)
-- then we add node to HAPROXY and re-enable monitorning.

---
class: larger, middle
`$ ansible-playbook deploy-playbook.yml -i /hosts/acceptance --extra-vars "version=1.1.2"`

`$ ansible-playbook deploy-playbook.yml -i /hosts/exploratory --extra-vars "version=1.1.2"`

`$ ansible-playbook deploy-playbook.yml -i /hosts/production --extra-vars "version=1.1.2"`
???
- You can run another playbook that installs necessary stuff on the box.
- Ask.fm style deployment: pipeline step - deploy single node, deploy 50%, deploy the rest.

---
.l70[
### - bot: building **1.1.2** from commit [[add healtchecks](https://github.com/eduardsi/cucumber-3g/commit/fb60f27628b3eddbc81f94faf3a56ffa77692868)] by @eduardsi
### - bot: **1.2.2** passed [commit stage]()
### - bot: **1.2.2** passed [acceptance tests]()
### - bot: **1.1.2** ready to be promoted to [exploratory testing]()
### - $ promote 1.1.2
### - bot: **1.1.2** is available at http://exploratory.app.io/1.1.2
### - $ promote 1.1.2 --single 50% 100%
]
.r30[
  ![](hubot.jpg)
]

---
.l70[
### - $ features list
### - bot: /facebook-registration (disabled)
###&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/twitter-registration (enabled, 100%)
### - $ features enable facebook-registration 10%
### - $ features list
### - bot: /facebook-registration (enabled 10%)
###&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/twitter-registration (enabled, 100%)
]
.r30[
  ![](hubot.jpg)
]

---
class: medium
<canvas width="1000" height="20" class="red absolute" style="top: 170px" />
### supervisor.conf
```supervisord
[program:app]
command=java -port=3000 -log.dir=/var/log/app/ -jar /opt/app/current/app.jar
user=deployer
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/var/log/app/stdout.log
stderr_logfile=/var/log/app/stderr.log
```
???
- PLEASE! Application must start with a reasonable defaults. Defaults must be printed out upon start into the log file!
- Parameters that must be provided are well-documented. Not in documenent, but in code!
- Otherwise you start app, it crashes with NPEs, you pass param, wrong format etc.

---
class: medium
# Arg4j
```java
  @Option(name="-port", usage="HTTP port the application will run on")
  public Integer port;
  ...
  @Option(name="-log.dir", usage="A directory where logs will be written to")
  public File logDir;
  ...
```
```
$ java -jar app.jar -wrong
```

```
"-wrong" is not a valid option
Application [options]
 -port   VAL  : HTTP port the application will run on
 -logDir FILE : A directory where logs will be written to
```

---
### deploy-playbook.yml
```ansible
- hosts: all
  serial: 1
  tasks:
   - name: install the app
     yum: name=app-{{version}} state=present
     notify:
      - restart supervisord
  handlers:
    - name: restart supervisord
      service: name=supervisord state=restarted

    - name: start the app
      supervisorctl: name=app state=started

    - name: health check
      health_check:
          url: "{{inventory_hostname}}/health"
          delay_between_tries: 5
          max_retries: 20
          expected_regexp: "alive"
  pre_tasks:
    - name: disable nagios alerts for this host webserver service
      nagios: action=disable_alerts host={{ inventory_hostname }} services=webserver

    - name: disable the server in haproxy
      haproxy: state=disabled host={{ inventory_hostname }}

    - name: stop the app
      supervisorctl: name=app state=stopped
```
<canvas width="600" height="90" class="red bottom" style="bottom: 177px" />

---
class: larger
.l30[
```
/health

/version

/info

/metrics

/env

/configprops

/trace

/mappings

/logfile

/dump

/shutdown
```
]
.r70[
```json
{
    "counter.status.200.root": 20,
    "counter.status.200.metrics": 3,
    "counter.status.200.star-star": 5,
    "counter.status.401.root": 4,
    "gauge.response.star-star": 6,
    "gauge.response.root": 2,
    "gauge.response.metrics": 3,
    "classes": 5808,
    "classes.loaded": 5808,
    "classes.unloaded": 0,
    "heap": 3728384,
    "heap.committed": 986624,
    "heap.init": 262144,
    "heap.used": 52765,
    "mem": 986624,
    "mem.free": 933858,
    "processors": 8,
    "threads": 15,
    "threads.daemon": 11,
    "threads.peak": 15,
    "threads.totalStarted": 42,
    "uptime": 494836,
    "instance.uptime": 489782,
    "datasource.primary.active": 5,
    "datasource.primary.usage": 0.25
}
```
]
???
/info - arbitrary info (like git commit version)


---
background-image:url(actuator.png)

---
background-image:url(metrics.png)

---
<canvas width="600" height="80" class="red bottom" style="bottom: 80px" />
.l70[
### - bot: building **1.1.2** from commit [[add healtchecks](https://github.com/eduardsi/cucumber-3g/commit/fb60f27628b3eddbc81f94faf3a56ffa77692868)] by @eduardsi
### - bot: **1.2.2** passed [commit stage]()
### - bot: **1.2.2** passed [acceptance tests]()
### - bot: **1.1.2** ready to be promoted to [exploratory testing]()
### - $ promote 1.1.2
### - bot: **1.1.2** is available at http://exploratory.app.io/1.1.2
### - $ promote 1.1.2 --single 50% 100%
]
.r30[
  ![](hubot.jpg)
]

---
background-image:url(query-log-json.png)
???
Too much data, can miss something, doesn't work :(

---
background-image:url(graylog.png)
???
People have Graylog and sit with open windows all day :-) Or watch logs after production deployment :-)


---
background-image:url(graylog_alert.png)
???
- Streams and Alerts - e.g. one cash miss doesn't mean anything. 20% cache miss - ouch!

---
background-image:url(jenkins_graylog_golive.png)

---
background-image:url(fluentd_before.png)
???
- Maxmind GeoIP databases
- Sensu - OSS, plugins for java heap, slow queries. Provisionable, Used by Tesla!
- Dashing - PROACTIVE vs. REACTIVE. You monitor trends (like CPU utilization, disk space, queue size). If CEO calls you - too late :-)
- S3 - How slow is is PayPal's API? How slow was PayPal's API yesterday?


---
background-image:url(fluentd_logo.png)
???
Fluentd has four key features that makes it suitable to build clean, reliable logging pipelines:
- fluentd structures everything as json
- pluggable architecture, hunders of plugins
- very lightweight, writtein C
- relible forwarding, supports failover, setup for HA
- reactive alerts

---
background-image:url(fluentd.png)

---
class: invert, right
background-image:url(fluentd_example.png)
### curl -X POST -H "Content-Type: application/json" -d '{"event":"data"}' \
### localhost:9880/app.request
???
file must be kept in version contorl together with infrastructure

---
- Preflights - BRANCHES AGAIN! :))) Virtualization - locally or wherever.
- acceptance testing, exploratory on real data
- Duplicate traffic to test node (new node)?
- Deadling with data
- Dynamism
- Configuration management
- Organizational patterns / batching / bringing CD to the company
- Continuous Security



---
background-image:url(jenkins_pipeline.png)

---
background-image:url(jenkins_pipeline.png)
<canvas width="1000" height="150" class="red bottom" />

---
class: center, middle
# Reliable deployments require Reliable Deployment System
???
pipeline is critical, because critical deployments go through it.

---
class: center, middle
# All changes to Jenkins go through version control and Jenkins can be rebuilt in automated fashion
???
- 3W
- Means there are no manual changes, plugins installs via UI.

---
class: center, middle, invert, bad
# Golden Image

---
class: larger
# Job DSL Plugin
```groovy
def project = 'quidryan/aws-sdk-test'
def branchApi = new URL("https://api.github.com/repos/${project}/branches")
def branches = new groovy.json.JsonSlurper().parse(branchApi.newReader())
branches.each {
    def branchName = it.name
    def jobName = "${project}-${branchName}".replaceAll('/','-')
    job(jobName) {
        scm {
            git("git://github.com/${project}.git", branchName)
        }
        steps {
            maven("test -Dproject.name=${project}/${branchName}")
        }
    }
}
```

---
background-image:url(gradle-jenkins-plugin.png)

---
class: center, middle
# TTD and TTR metrics are defined by SLA of the most critical system
???
- HA across AZ
- Are you 100% your "recovery plan" works?
- Do you have disaster recovery plan for the Jenkins, as for apps?
- Do you monitor Jenkins, as your apps? Disk space trends etc.
- DockerHub? Local artifact repository?
- GitHub fails every year.

---
background-image:url(githubdown2012.png)

---
background-image:url(githubdown2012_2.png)
???
more than 5 hours of downtime. Your 5H of missed SLA :-)

---
background-image:url(githubdown2016.png)
???
2 hours

---
background-image:url(githubdown.png)
???
1.2 hours.


---
class: center, middle
# Metadata survives the crash (build number, logs, history)
???

---
class: center, middle
# Slaves survive the crash

---
class: center, middle
# All changes to Jenkins are pre-flight tested

---
background-image:url(massala.png)
???
Completely erased all your servers and all your backups in a single strike

---
class: center, middle
# Each team has their own Jenkins and owns underlying infrastructure
???
- 100 Apps are build on a single Jenkins
- 100 Jenkins instances on single VM - good luck!

---
class: center, middle
# Hardware is never a bottleneck

---
class: center, middle
# Jenkins is either auto-scalable or easy to scale

---
class: center, middle
# Jenkins is at the close proximity with dependencies (which are redundant)


---
Forget centralized test environment. Either locally or on AWS. Save money!

DB migrations similar to configuration.
blue-green

Rollbacks?

---
Git Sparse Chechouts! 1.7.0+

---
Images make your builds slow, but rollbacks fast!

---
background-image:url(identical_environments.png)
## Creating identical environments

---
background-image:url(ansible.png)
???
TDD for Ansible :-)
http://serverspec.org/
https://github.com/aelsabbahy/goss
KitchenCI

---
Typiacal issue: pressing the button at 00:00 :-)

---
```
# playbook.yml
---
- hosts: 127.0.0.1
  sudo: yes
  connection: local
  tasks:
    - name: "ensure redis is up and running"
      service: name=redis enabled=yes state=started
    - name: Installs nginx web server
      apt: pkg=nginx state=installed update_cache=true
      notify:
        - start nginx

  handlers:
    - name: start nginx
      service: name=nginx state=started
```

---
class: black
background-image:url(packer.png)

---
class: middle
```
# sandbox.json
{
  "variables": {
    "aws_access_key": "",
    "aws_secret_key": ""
  },
  "builders": [{
    "type": "amazon-ebs",
    "access_key": "{{user `aws_access_key`}}",
    "secret_key": "{{user `aws_secret_key`}}",
    "region": "us-east-1",
    "source_ami": "ami-80878fea",
    "instance_type": "m1.small",
    "ssh_username": "ubuntu",
    "ami_name": "packer-example {{timestamp}}"
  }],
  "provisioners": [{
    {
      "type": "ansible-local",
      "playbook_file": "playbook.yml"
    }
  }],
  "post-processors": ["vagrant"]
}
```
## `packer build sandbox.json`

---
background-image:url(vagrant.png)

---

##`vagrant box add {{location}}/sand.box`
## `vagrant up`

---
## Gains:
### - Environments are identical and always in sync (no [Snowflake Server](http://martinfowler.com/bliki/SnowflakeServer.html))
### - All the same cookbooks on the same OS
### - Hackable (not your granny's Wiki setup instructions)
### - Uber-fast onboarding
???
Auto-scaling on AWS!

---
# Phoenix? EC2 Instances may be uber-short living (Ephemeral). Monitoring system must adapt!
???
Locked Phoenix - a phoenix server that cannot be logged into, therefore cannot be compromised and hacked.

---
ALTER TABLE
???
Read-locks the table (with few exceptions, Online DDL from MySQL 5.6)

---
background-image:url(percona.png)
???
Double-space please
BE CAREFUL! A LOT OF CONFIGURATION and testing, especially in demanding environments.

---
## Pain:
### - Virtualbox is slow
### - 2+ Virtualbox = Kernel panic
???
Environment can be on Virtualbox, AMI, **Docker**... (container including all dependencies)

---
background-image:url(vagrant_vmware.png)

---
background-image:url(docker.png)
### - All-in-one Container
### - Container per Service

---
class: bad
# Dockerfiles
```
FROM nginx
RUN rm -f /etc/nginx/conf.d/*

RUN apt-get update && apt-get install -my \
  supervisor \
  curl \
  wget \
  php5-curl \
  php5-fpm \
  php5-gd \
  php5-memcached \
  php5-mysql \
  php5-mcrypt \
  php5-sqlite \
  php5-xdebug \
  php-apc

RUN sed -i "s/user = www-data/user = root/" /etc/php5/fpm/pool.d/www.conf
RUN sed -i "s/group = www-data/group = root/" /etc/php5/fpm/pool.d/www.conf
RUN sed -i '/^;clear_env = no/s/^;//' /etc/php5/fpm/pool.d/www.conf
RUN sed -i '/^;ping\.path/s/^;//' /etc/php5/fpm/pool.d/www.conf
RUN sed -i '/^;pm\.status_path/s/^;//' /etc/php5/fpm/pool.d/www.conf
```

---
background-image:url(packer_docker_builder.png)

---
background-image:url(docker_compose.png)
## Container per Service

---
```
# docker-compose.yml
version: '2'
services:
  app:
    build: .
    ports:
     - "5000:5000"
    volumes:
     - .:/code
    depends_on:
     - redis
  redis:
    image: redis:2.8
```
???
Good thing, since Docker can live on production.

---
background-image:url(docker_compose_up_redis.png)

---
background-image:url(docker_compose_scale.png)

---
# Exploratory testing

---
QA in production.

---
PhantomJS running with http://testcontainers.viewdocs.io/testcontainers-java/
Trying embedded things, but sometimes we need Redis.
???
Mac OSX users should be aware that PhantomJS doesn't load the FontAwesome glyths used in the test suite, I don't understand why. I fixed this locally by downloading FontAwesome and double clicking on the .otf file to install the font.


---
# Configuration management
no internal @Profiles. No env-soecific ifs

---


---
- Application must be environment agnostic. No env-conditionals inside, no deciding which configuration to load.
- Version Controlled
- Journalled - who/when/what

---
- configuration is part of app release (12-factor app style)
- configuration is versioned, but lives inpedendently

---
Spring Boot style
https://spring.io/blog/2015/01/13/configuring-it-all-out-or-12-factor-app-style-configuration-with-spring
???
@Value("$(configurationKey)") String configurationKey
- Local development configuration in local .yaml file
- Transforms runtime parameters -Dkey=value and environment variables () into configuration
- Other configuration on GitHub. /refresh endpoint with @RefreshScope beans

---
Dealing with Dynamic infrastructure (e.g. auto-scaling). Consul to the rescue! What about less dynamic configuration?
???
Consul DNS! 0 TTL by default :-) Nice! Prevents routing to unhealty nodes. Random robin from healty notes.
???
Docker-Consul Registrator (service that you run): http://gliderlabs.com/registrator/latest/user/quickstart/

---
background-image:url(consul-template.png)

---
background-image:url(consul-template-example.png)

---
background-image:url(consul-template-example-restart.png)

---
background-image:url(confd.png)

---
So, you keep Configuration Templates in GitHub and use git2consul. consul-template listen for Consul and generates configuration - (discovered stuff from Consul, credentials from Vault, other stuff hard-coded)

---
git2consul (https://github.com/Cimpress-MCP/git2consul) -> envconsul (https://github.com/hashicorp/envconsul)

---
Problem! Ephemeral servers? IP changes! Docker containers spin up! New instances get added. What if servers die? :-) How to unregister it?
Configuration dependency inversion.

---
- Docker pre-bundled. Slow. Env-specific container :(
- Phoenix server - the same.
- Data and configuration has different change cadence than the app.


---
12-factor app
![](12factor_config.png)
The source of environment configuration should be read when preparing a release, and that any change to config, just like with a change to code, results in a new release.
???
- App + configuration = single, versioned deploy unit. Rollback (capistrano keeps old versions and rollback command)
- I WOULD ARGUE: feature toggles? gradual rollouts? thread pool size?

---
background-image:url(12factor_env.png)
The environment is right there. Use it.

---
background-image:url(envdir.png)

---
One of the biggest misinterpretations is people thinking 12factor says “config should never be in a file anywhere”.

12factor says config should not be in a file in your app, and your app should read from the environment. It has very little to say about where the environment might be sourced from.

You’ll almost certainly have your config in some files somewhere.

Update: This may be hiera if you use Puppet, or via some other configuration management system, or just plain files but in a different repo. 12factor primarily talks about building apps and not about building the environment they are deployed to.

The point is that:

Wherever you store your config, it is distinct from the app
Your app reads its config from the environment

---
So, changing consul and restarting the app is kinda... Not 2-factor app friendly.
???
if your code and config is managed in separate lifecycles, it ain’t Twelve Factor compatible.

---
\- It doesn’t appear to leave any room for runtime config changes
\- It’s not completely clear how it would work with dynamic service discovery
Sometimes, however, the advantages of predictable, easy to reason about deployments outweigh the benefits of such niceties


## Co-located (spirit of 12-factor app, where configuration changes together with app and is part of release. How do you A/B test this stuff?. You probbaly have infarstructure of A/B already. Now you need two :-)
## GitHub
## etcd (key-value store actually)

---
Which parts to reload? Much easier to restart the whole app!

---
https://www.hashicorp.com/blog/twelve-factor-consul.html

---
mitmproxy / mitmdump
background-image:url(mitmproxy.png)
???
mitmproxy - interactive app
mitmdump - console app

---
<iframe width="1280" height="720" src="https://www.youtube.com/embed/j_hwVb1Vc2U" frameborder="0" allowfullscreen></iframe>
???
Omg, you can change any websites behaviour w/o changing the website!

---
background-image:url(pathod.png)
???
pathod - any response that violate HTTP specification
pathoc - any request
I managed to kill vert.x this way.
???
low-hanging fruits :-) usually, there are many!

---
# Rate limiting (nginx, HAProxy, Varnish, ELB does not have rate limiting)
# org.eclipse.jetty.servlets.DoSFilter
# Implementing your own (Guava's RateLimiter)
# The only way to protect from DDoS - make it financially unviable.
# CloudFlare
---
What happens if AWS is under DDoS and auto-scaling goes crazy? Same as CloudFlare, for all-layer attacks.

---
# Continuous Security

Use 2-Factor authentication for accessing something important. Using service that uses 2-Factor authentication.
- share public gist
- tweet

-

---
https://keybase.io/
Very popular in OSS world and requires invitation. I have 8 invites, let me know if you need one.

---
background-image:url(verified.png)

---
Gitrob as part of pipeline
https://github.com/michenriksen/gitrob
???
Gitrob is reactive: after push, E.g. whether you stored password and do not want to be Bitcoin mined
Talisman is proactive: https://github.com/thoughtworks/talisman

---
background-image:url(gauntlt.png)
???
open port scanner, xss, sql injection, session id length and crypto-function, secure cookies,
SecDevOps

---

Let's Encrypt

---
background-image:url(transcrypt.png)

---
```
The current repository was configured using transcrypt version 0.9.6
and has the following configuration:

  CIPHER:   aes-256-cbc
  PASSWORD: MEu5xyQ&G@/}:D\___1231aala4

Copy and paste the following command to initialize a cloned repository:

  transcrypt -c aes-256-cbc -p 'MEu5xyQ&G@/}:D\___1231aala4'
```

---
background-image:url(gitcrypt.png)
???
Secrets goes everywhere. Hard to keep track and control access. Actions if compromised = change master password, so everything breaks :-)

---
Access revocation?
???
Just remove access from GitHub. Anyway, access to old code will be granted :-)

---
background-image:url(vault.png)
???
- Dynamic key generation
- User password management inside enterprise
- Centralized data encryption / decryption solution
- Issuing temporary credentials for manual access!

---
Backends!
- Dynamic SQL user creation
- Dynamic AWS access keys! Cannot be stolen, as they do not exist before they are read! Every client has different keys - wohoo.
- Cassandra, MySQL, Postgres, SSH!
???
SSH - do not need to share private key for EC2 :-)


---
Unsealing vault (on every start). Ouch! Because the master key is not stored, but generated every time Vault is started.

---
- all operations wiht secret are leased! No exceptions.
- Pre-bundling secrets in S3 stored images?
- Fine-grained control which access tokens can access which secrets.
- OK, what about audit log? e.g. which app accessed the key, when
- Servers must know and get the secret / a key to decrypt the data. Many servers!

---
class: center, middle
## Our recommended approach to use Vault with any configuration manage tool is to move the secret retrieval and renewal into a runtime process instead of a build time process.
###- [excerpt](https://www.hashicorp.com/blog/using-hashicorp-vault-with-chef.html) from Vault documentation
???
- Unable to handle lease revocation events
- Unable to handle secret updates
- Can easily become stale
- Cannot use secrets that require lease renewal (read on)

---
Then when applications request access to those secrets, Vault does not give out the root credentials

---
background-image:url(gauntit_code.png)


---
Bug Bounties!
https://hackerone.com/
https://bugcrowd.com

---
# Testing firewalls / IDS
### Signature-based detection
### Behaviour-based detection)
### Web App Firewalls (ModSecurity, CloudFlare, Incapsula)
### OWASP Core Rule Set against OWASP Top 10
???
- How do we handle bots? Blocking traffic (ouch!) or SHOWING CAPTCHA
- SBD - Hei, I saw that behaviour before. Must be a bot! COMPARISON (ip reputation, common attacks like XSS)
- BDD - Hei, looks like this client is doing suspicious stuff. Must be a bot! SIGNS OF SUSPICIOUS ACTIVITIES, ANOMALIES. ML.

---
You test in on production! :-)

---
### Behaviour-based detection
???

---
```10.20.253.8 - - [23/Apr/2013:14:20:21 +0000] "POST /login HTTP/1.1" 200 267"-" "Mozilla/ 5.0 (Windows NT 6.1; WOW64; rv:8.0) Gecko/ 20100101 Firefox/8.0" "77.77.165.233" Wednesday, July 10, 13```

---
```10.20.253.8 - - [23/Apr/2013:14:20:22 +0000] "POST /users/king-roland/credit_cards HTTP/ 1.1" 302 2085 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:8.0) Gecko/20100101 Firefox/ 8.0" "77.77.165.233" Wednesday, July 10, 13```

---
```10.20.253.8 - - [23/Apr/2013:14:20:23 +0000] "POST /users/king-roland/credit_cards HTTP/ 1.1" 302 2083 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:8.0) Gecko/20100101 Firefox/ 8.0" "77.77.165.233" Wednesday, July 10, 13```

---
```10.20.253.8 - - [23/Apr/2013:14:20:24 +0000] "POST /users/king-roland/credit_cards HTTP/ 1.1" 302 2085 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:8.0) Gecko/20100101 Firefox/ 8.0" "77.77.165.233" Wednesday, July 10, 13```

---
- User Agent
- Action (adding credit to account, no other actions)
- Http method distribution
- Request Rate
- IP (Bulgaria). Gmail security?

---
# Conclusion:
- Do not use your own Firewall
- Make rules easy testable (e.g. captcha, rate limiting)
- To make it easy testable, push functionality down to the app

---
background-image:url(shader.png)

---
background-image:url(heartbleed.png)
???
- I ran scanner on my EC2 machines and ALL of them had vulnerable OpenSSL :-)
- April 2014

---
class: center, middle
![](mozilla-wiki.png)
### [WebAppSec/Secure Coding Guidelines](https://wiki.mozilla.org/WebAppSec/Secure_Coding_Guidelines)



---
OWASP Application Security Verification Standard Project
https://www.owasp.org/images/6/67/OWASPApplicationSecurityVerificationStandard3.0.pdf
???
Guidelines.

---
background-url(owasp.png)

---
### The OWASP Zed Attack Proxy (ZAP) is one of the world’s most popular free security tools and is actively maintained by hundreds of international volunteers*. It can help you automatically find security vulnerabilities in your web applications while you are developing and testing your applications. Its also a great tool for experienced pentesters to use for manual security testing.

---
background-image:url(zap-webdriver.png)

---
background-image:url(zap-checks.png)

---
class: center, middle
# Evil user stories
### `As {some kind of bad guy} I want to {do some bad thing}…`
![](evil_stories.gif)
???
Thinking like a bad guy.

---
Single CI for all teams :-)

---
Simplicity.
???
Software might need to scale. No real stories of failed business during "unexpected" load.

---
background-image:url(jenkins_ec2.png)

---
AWS Lambdda - Serverless.
???
Cool stuff, testing is painful (there are applications that emulate AWS lambda locally)

---
From Circle CI documentation:
### `Every time you push to your VCS system, we checkout your code and run your build inside of a fresh, on-demand, and isolated Linux container pre-loaded with most popular languages, tools, and framework. CircleCI, in many cases, will detect and automatically download and cache your dependencies, and you can fully script any steps or integrations.`

---
background-image:url(containers.png)
## Containers

---
# [An empirical study of flaky tests](http://mir.cs.illinois.edu/~qluo2/fse14LuoHEM.pdf)

- asynchronous waits
```click_button "Send"
sleep 5
expect_email_to_be_sent
```
- concurrency
- test order dependency


---
`You don't push code that relies on schema changes until the schema has successfully gone out, and you don't push schema changes unless your automated tests show that they work in production.`
[Continuous Deployment at IMVU: Doing the impossible fifty times a day.](http://timothyfitz.com/2009/02/10/continuous-deployment-at-imvu-doing-the-impossible-fifty-times-a-day/)

---
background-image:url(simian_army.png)
# https://github.com/Netflix/SimianArmy

---
Consul

---
UI: PhantomJs!
headless Firefox (screen emulator)

---
background-image:url(ievms.png)
???
69 GB :-)

---
Browsersync
https://www.browsersync.io/
???
- all browser auto-update on change

---
Gatling
???
Cloud - Load Impact

---
http://martinfowler.com/articles/microservice-testing/#testing-end-to-end-diagram

???
- auto-scaling can be predictive (http://techblog.netflix.com/2013/11/scryer-netflixs-predictive-auto-scaling.html). Otherwise it may be too late. You can do the same with Jenkins btw.

---
# PINGDOM
???
Why do you need Pingdom? Because your Zabbix is UNDER firewall :-)
Pingdom measures response time from different locations.

---
Graceful Degradation
- Twitter example - served AD precision depends on server utilisation.

---
# Implementing Continuous Delivery
### - Find a bottleneck, set a goal
### - Find the .strike[best] simplest possible solution and get sh%t done
### - Repeat.
# Recursive 80/20.
# Grow DevOps Experts.
# Redefine DONE
# Planning and Retrospectives
# Commitment language
# Build quality in.
???
Re-define DONE. People still have "siloed", non-cross-functional thinking.

---
Risk-storming.

---
class: center, middle
<iframe width="1280" height="720" src="https://www.youtube.com/embed/ZXsQAXx_ao0" frameborder="0" allowfullscreen></iframe>

---
class: center, middle
# Thank you!

    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        ratio: '16:9',
        slideNumberFormat: function (current, total) { return "" }
      })

    </script>
  </body>
</html>
